<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Landscape REPL</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:20px; }
    table.selection-table { border-collapse:collapse; margin:0 auto 20px; width:80%; max-width:800px; background:#fff; }
    table.selection-table th, table.selection-table td { border:1px solid #888; padding:6px 10px; text-align:center; }
    table.selection-table thead { background:#f0f0f0; font-weight:bold; }
    .tabs { text-align:center; margin-bottom:10px; }
    .tablink { display:inline-block; padding:8px 16px; margin:0 4px; border:0; border-radius:4px 4px 0 0; background:#ddd; cursor:pointer; font-size:14px; }
    .tablink.active { background:#0078d7; color:#fff; }
    .tabcontent { display:none; position:relative; }
    fieldset.control-block { display:block; margin:15px auto; padding:15px; width:400px; max-width:95%; border:1px solid #aaa; border-radius:6px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    fieldset.control-block legend { font-weight:bold; }
    fieldset.control-block label { display:inline-block; width:140px; text-align:right; margin-right:8px; }
    fieldset.control-block input[type="number"] { width:120px; padding:3px; margin:3px 0; }
    fieldset.control-block input[type="button"] { margin:4px 0; padding:4px 10px; cursor:pointer; }
    .info-box { margin-top:10px; padding:6px; background:#f9f9f9; border:1px dashed #aaa; font-size:12px; min-height:30px; white-space:pre-wrap; }
    a { display:block; text-align:center; margin-top:20px; }
    .tab-help { position:absolute; right:10px; bottom:10px; padding:8px 12px; border:0; border-radius:8px; background:#0078d7; color:#fff; font-weight:600; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.2); }
    .tab-help:hover { filter:brightness(1.05); }
    .tab-help:active { transform:translateY(1px); }
    #log-box { margin-top:10px; padding:8px; background:#111; color:#0f0; font-family:monospace; font-size:12px; height:100px; overflow:auto; }
  </style>

  <script type="text/javascript">
    // ---------- helpers ----------
    function AddLog(msg) {
      const box = document.getElementById('log-box');
      if (!box) return;
      const now = new Date().toLocaleTimeString();
      box.innerText += "\n[" + now + "] " + msg;
      box.scrollTop = box.scrollHeight;
    }
    function setInfo(id, msg) { const el = document.getElementById(id); if (el) el.innerText = msg; }
    function parseNumber(inputEl, def = 0) {
      let v = (typeof inputEl.valueAsNumber === 'number' && !isNaN(inputEl.valueAsNumber)) ? inputEl.valueAsNumber : NaN;
      if (isNaN(v)) {
        const p = parseFloat(String(inputEl.value || "").replace(',', '.'));
        v = Number.isFinite(p) ? p : def;
      }
      return v;
    }

    // ---------- таблица выделения ----------
    function UpdateSelectedElements() {
      if (!window.ACAPI || typeof ACAPI.GetSelectedElements !== 'function') {
        AddLog('[UI] ACAPI.GetSelectedElements недоступен');
        return;
      }
      ACAPI.GetSelectedElements().then(function (elemInfos) {
        const selectionTable = document.getElementById('selection');
        while (selectionTable.firstChild) selectionTable.removeChild(selectionTable.firstChild);

        if (!elemInfos || elemInfos.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="3">Нет выбранных элементов</td>';
          selectionTable.appendChild(tr);
          return;
        }

        const grouped = {};
        for (let i = 0; i < elemInfos.length; i++) {
          const typeName = elemInfos[i][1];
          const elemID   = elemInfos[i][2];
          const key = typeName + "||" + elemID;
          if (!grouped[key]) grouped[key] = { type: typeName, id: elemID, count: 0 };
          grouped[key].count++;
        }

        Object.keys(grouped).forEach(key => {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>'+grouped[key].type+'</td><td>'+grouped[key].id+'</td><td>'+grouped[key].count+'</td>';
          selectionTable.appendChild(tr);
        });
      }).catch(err => AddLog('[UI] GetSelectedElements error: ' + err));
    }

    // ---------- действия ----------
    function RotateSelection() {
      const s = document.getElementById('rotateAngle').value;
      if (window.ACAPI && typeof ACAPI.RotateSelected === 'function') ACAPI.RotateSelected(s);
      setInfo("info-orient", "Повернули на " + s + "°");
    }
    function AlignSelectionX() { if (ACAPI?.AlignSelectedX) ACAPI.AlignSelectedX(); setInfo("info-orient", "Выравнивание по X"); }
    function RandomizeAngles() { if (ACAPI?.RandomizeSelectedAngles) ACAPI.RandomizeSelectedAngles(); setInfo("info-orient", "Случайный угол задан"); }
    function OrientObjectsToPoint() { if (ACAPI?.OrientObjectsToPoint) ACAPI.OrientObjectsToPoint(); setInfo("info-orient", "Сориентированы на точку"); }

    function SetDistributionLine(){ ACAPI?.SetDistributionLine && ACAPI.SetDistributionLine(); setInfo("info-dist","Линия задана"); }
    function SetDistributionObject(){ ACAPI?.SetDistributionObject && ACAPI.SetDistributionObject(); setInfo("info-dist","Объект задан"); }

    function SetDistributionStep () {
      const s = parseNumber(document.getElementById('distStep'), 0);
      const step = (isFinite(s) && s > 0) ? s : 0;
      ACAPI?.SetDistributionStep && ACAPI.SetDistributionStep(step);
      if (step > 0) {
        const payload = "step:" + step;
        AddLog("[UI] Step OK → " + payload);
        if (ACAPI?.DistributeNow) {
          ACAPI.DistributeNow(payload).then(ok => setInfo("info-dist", ok ? "✔ Разложено по шагу" : "❌ Ошибка раскладки"));
        }
      } else setInfo("info-dist", "Шаг должен быть > 0");
    }

    function SetDistributionCount () {
      const c = parseInt((document.getElementById('distCount').value || "0"), 10);
      const count = (isFinite(c) && c > 0) ? c : 0;
      ACAPI?.SetDistributionCount && ACAPI.SetDistributionCount(count);
      if (count > 0) {
        const payload = "count:" + count;
        AddLog("[UI] Count OK → " + payload);
        if (ACAPI?.DistributeNow) {
          ACAPI.DistributeNow(payload).then(ok => setInfo("info-dist", ok ? "✔ Разложено по количеству" : "❌ Ошибка раскладки"));
        }
      } else setInfo("info-dist", "Количество должно быть ≥ 1");
    }

    function CreateSlabAlongCurve(){
      const w = parseNumber(document.getElementById('slabWidth'), 0);
      ACAPI?.CreateSlabAlongCurve && ACAPI.CreateSlabAlongCurve(w);
      setInfo("info-build","Перекрытие, ширина=" + w);
    }
    function CreateShellAlongCurve(){
      const w = parseNumber(document.getElementById('shellWidth'), 0);
      ACAPI?.CreateShellAlongCurve && ACAPI.CreateShellAlongCurve(w);
      setInfo("info-build","Оболочка, ширина=" + w);
    }

    function GenerateGDLFromSelection() {
      if (!ACAPI?.GenerateGDLFromSelection) { AddLog('[UI] ACAPI.GenerateGDLFromSelection недоступен'); return; }
      ACAPI.GenerateGDLFromSelection().then(code => {
        document.getElementById('gdlOutput').value = code || "Ничего не выделено или не поддерживается";
      });
    }

    // ---------- вкладки (глобально!) ----------
    function openTab(evt, tabId) {
      const contents = document.getElementsByClassName("tabcontent");
      const links = document.getElementsByClassName("tablink");
      for (let i = 0; i < contents.length; i++) contents[i].style.display = "none";
      for (let i = 0; i < links.length; i++) links[i].classList.remove("active");
      document.getElementById(tabId).style.display = "block";
      evt.currentTarget.classList.add("active");
    }
    window.openTab = openTab; // чтобы было доступно из onclick

    // ---------- init + делегатор помощи ----------
    window.addEventListener('DOMContentLoaded', function () {
      AddLog("[UI] Ready");

      // Enter-нажатия для числовых полей
      const step = document.getElementById('distStep');
      const cnt  = document.getElementById('distCount');
      step?.addEventListener('keydown', e => { if (e.key === 'Enter') SetDistributionStep(); });
      cnt ?.addEventListener('keydown',  e => { if (e.key === 'Enter') SetDistributionCount(); });

      // Делегирование кликов по любым элементам с data-help-url
      document.addEventListener('click', function (e) {
        const el = e.target.closest('[data-help-url]');
        if (!el) return;

        e.preventDefault();
        const url = el.getAttribute('data-help-url') || 'https://landscape.227.info/help/start';
        AddLog('[UI] help → ' + url);

        if (window.ACAPI && typeof ACAPI.OpenHelp === 'function') {
          Promise.resolve(ACAPI.OpenHelp(url))
            .then(() => AddLog('[UI] ACAPI.OpenHelp ok'))
            .catch(err => AddLog('[UI] ACAPI.OpenHelp error: ' + err));
        } else {
          AddLog('[UI] ACAPI.OpenHelp не найден → window.open');
          window.open(url, '_blank', 'noopener,noreferrer');
        }
      });

      UpdateSelectedElements();
      document.getElementById("defaultTab").click();
    });
  </script>
</head>

<body>
  <!-- Таблица выделения -->
  <table class="selection-table">
    <thead>
      <tr><th colspan="3">Выбранные элементы:</th></tr>
      <tr><th>Тип</th><th>ID</th><th>Кол-во</th></tr>
    </thead>
    <tbody id="selection"><tr><td colspan="3">Нет выбранных элементов</td></tr></tbody>
  </table>

  <!-- Вкладки -->
  <div class="tabs">
    <button id="defaultTab" class="tablink" onclick="openTab(event,'tab-build')">Построение</button>
    <button class="tablink" onclick="openTab(event,'tab-distrib')">Распределение</button>
    <button class="tablink" onclick="openTab(event,'tab-orient')">Ориентация</button>
    <button class="tablink" onclick="openTab(event,'tab-ground')">Приземление</button>
    <button class="tablink" onclick="openTab(event,'tab-gdl')">GDL</button>
  </div>

  <!-- Построение -->
  <div id="tab-build" class="tabcontent">
    <fieldset class="control-block">
      <legend>Перекрытие по линии</legend>
      <div style="text-align:center; margin-bottom:6px;">
        <input type="button" onclick="ACAPI.SetCurveForSlab && ACAPI.SetCurveForSlab()" value="Выбрать линию">
      </div>
      <div>
        <label>Ширина:</label>
        <input type="number" id="slabWidth" step="1" value="1000">
        <input type="button" onclick="CreateSlabAlongCurve()" value="Построить Перекрытие">
      </div>
    </fieldset>

    <fieldset class="control-block">
      <legend>Оболочка по линии</legend>
      <div style="text-align:center; margin-bottom:6px;">
        <input type="button" onclick="ACAPI.SetCurveForShell && ACAPI.SetCurveForShell()" value="Выбрать линию"><br><br>
        <input type="button" onclick="ACAPI.SetMeshForShell && ACAPI.SetMeshForShell()" value="Выбрать 3D сетку">
      </div>
      <div>
        <label>Ширина:</label>
        <input type="number" id="shellWidth" step="1" value="1000">
        <input type="button" onclick="CreateShellAlongCurve()" value="OK">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <input type="button" onclick="CreateShellAlongCurve()" value="Построить Оболочку">
      </div>
      <div id="info-build" class="info-box">Подсказка: выберите линию/сетку и задайте параметры</div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/distribution?embed=1"
            data-help-title="Справка: Построение">Помощь</button>
  </div>

  <!-- Распределение -->
  <div id="tab-distrib" class="tabcontent">
    <fieldset class="control-block">
      <legend>Распределение</legend>
      <div style="text-align:center;">
        <input type="button" onclick="SetDistributionLine()" value="Задать линию"><br><br>
        <input type="button" onclick="SetDistributionObject()" value="Задать объект">
      </div>
      <div>
        <label>Расстояние:</label>
        <input type="number" id="distStep" step="1" value="0">
        <input type="button" onclick="SetDistributionStep()" value="OK">
      </div>
      <div>
        <label>Количество:</label>
        <input type="number" id="distCount" step="1" value="1">
        <input type="button" onclick="SetDistributionCount()" value="OK">
      </div>
      <div id="info-dist" class="info-box">Подсказка: задайте параметры</div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/distribution?embed=1"
            data-help-title="Справка: Распределение">Помощь</button>
  </div>

  <!-- Ориентация -->
  <div id="tab-orient" class="tabcontent">
    <fieldset class="control-block">
      <legend>Ориентация</legend>
      <div>
        <label>Угол:</label>
        <input type="number" id="rotateAngle" step="1" value="0">
        <input type="button" onclick="RotateSelection()" value="Повернуть">
      </div>
      <div style="text-align:center; margin-top:10px;">
        <input type="button" onclick="AlignSelectionX()" value="Выровнять по X"><br><br>
        <input type="button" onclick="RandomizeAngles()" value="Случайный угол (0-360)"><br><br>
        <input type="button" onclick="OrientObjectsToPoint()" value="Сориентировать на точку">
      </div>
      <div id="info-orient" class="info-box">Подсказка: задайте угол или выберите действие</div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/orientation?embed=1"
            data-help-title="Справка: Ориентация">Помощь</button>
  </div>

  <!-- Приземление -->
  <div id="tab-ground" class="tabcontent">
    <fieldset class="control-block">
      <legend>Приземление</legend>
      <div style="text-align:center; margin-bottom:10px;">
        <label>Смещение Z (мм):</label>
        <input type="number" id="groundOffset" step="1" value="0">
      </div>
      <div style="text-align:center;">
        <input type="button" onclick="GroundLanding()" value="Приземлить">
      </div>
      <div id="info-ground" class="info-box">
        Подсказка: выделите Поверхность (3D-сетку) + объекты, задайте смещение в мм и нажмите «Приземлить».
      </div>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/ground?embed=1"
            data-help-title="Справка: Приземление">Помощь</button>
  </div>

  <!-- GDL -->
  <div id="tab-gdl" class="tabcontent">
    <fieldset class="control-block">
      <legend>GDL-код из выделения</legend>
      <div style="text-align:center;">
        <input type="button" onclick="GenerateGDLFromSelection()" value="Создать GDL">
      </div>
      <textarea id="gdlOutput" style="width:95%;height:200px;margin-top:10px;font-family:monospace;"></textarea>
    </fieldset>

    <button class="tab-help"
            data-help-url="https://landscape.227.info/help/gdl?embed=1"
            data-help-title="Справка: GDL">Помощь</button>
  </div>

  <div id="log-box">[Лог плагина будет здесь]</div>

  <a href="#"
     data-help-url="https://landscape.227.info/?embed=1"
     data-help-title="LandscapeHelper — сайт">
    landscape.227.info
  </a>
</body>
</html>
